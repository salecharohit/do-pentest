resource "digitalocean_ssh_key" "pentest_key" {
  name       = "Pentest Key"
  public_key = file(var.public_key)
}

resource "digitalocean_tag" "type" {
  name = "pentest"
}

resource "digitalocean_droplet" "pentest" {
  name = "pentest"
  image = var.os
  region = var.region
  size = var.size
  private_networking = true
  tags   = [digitalocean_tag.type.id]
  ssh_keys = [
    digitalocean_ssh_key.pentest_key.id
  ]
  connection {
    host = self.ipv4_address
    user = "root"
    type = "ssh"
    private_key = file(var.pvt_key)
    timeout = "2m"
  }

  provisioner "file" {
    source      = "../ansible"
    destination = "/tmp/ansible"
  }

  provisioner "file" {
    source      = "script.sh"
    destination = "/tmp/script.sh"
  }
  
  provisioner "file" {
    source      = "pentest_key.pub"
    destination = "/tmp/pentest_key.pub"
  }

  provisioner "remote-exec" {
    inline = [
      "chmod +x /tmp/script.sh",
      "sudo /tmp/script.sh",
    ]
  }
}

resource "digitalocean_record" "www" {
  domain = var.domain_name
  type   = "A"
  name   = "@"
  value  = digitalocean_droplet.pentest.ipv4_address
}